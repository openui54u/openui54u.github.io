<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eddystone Beacon Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        #connectBtn {
            padding: 15px 30px;
            font-size: 18px;
            margin: 20px;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            background-color: blue;
            color: white;
        }
        #output {
            margin-top: 30px;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <h1>Eddystone Beacon Tracker</h1>

    <button id="connectBtn">CONNECT TO BEACON</button>

    <div id="output">
        <p><strong>Beacon Data:</strong></p>
        <p id="beaconType">Type: Unknown</p>
        <p id="beaconId">ID: N/A</p>
        <p id="beaconURL">URL: N/A</p>
        <p id="battery">Battery: N/A</p>
        <p id="temperature">Temperature: N/A</p>
    </div>

    <script>
        const connectBtn = document.getElementById('connectBtn');
        const beaconType = document.getElementById('beaconType');
        const beaconId = document.getElementById('beaconId');
        const beaconURL = document.getElementById('beaconURL');
        const battery = document.getElementById('battery');
        const temperature = document.getElementById('temperature');

        // Function to list GATT services
        async function connectToDeviceAndListServices() {
            try {
                const beaconDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['battery_service', 'device_information'] // Common services to start
                });

                console.log('Device selected:', beaconDevice.name);

                // Connect to GATT server
                const server = await beaconDevice.gatt.connect();

                // Get all services from the connected device
                const services = await server.getPrimaryServices();
                
                // Log each service's UUID
                console.log('Available services:');
                services.forEach(service => {
                    console.log('Service UUID:', service.uuid);
                });

                // Now you can explore characteristics of each service
                // Example: check battery level if available
                const batteryService = services.find(service => service.uuid === 'battery_service');
                if (batteryService) {
                    const batteryLevelCharacteristic = await batteryService.getCharacteristic('battery_level');
                    const batteryLevel = await batteryLevelCharacteristic.readValue();
                    console.log('Battery Level:', batteryLevel.getUint8(0), '%');
                    battery.textContent = `Battery: ${batteryLevel.getUint8(0)}%`;
                } else {
                    console.log('Battery service not available');
                }

            } catch (error) {
                console.error('Error connecting to Bluetooth device:', error);
            }
        }

        // Function to connect to a Bluetooth device and read Eddystone data
        async function connectToEddystoneBeacon() {
            try {
                const beaconDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000feaa-0000-1000-8000-00805f9b34fb'] // Eddystone Service UUID
                });

                console.log('Device selected:', beaconDevice.name);

                // Connect to GATT server
                const server = await beaconDevice.gatt.connect();

                // Call the function to list services
                connectToDeviceAndListServices();

                // Get the Eddystone service (UUID: FEAA)
                const service = await server.getPrimaryService('0000feaa-0000-1000-8000-00805f9b34fb');
                console.log('Connected to Eddystone service:', service);

                // Get the characteristic for Eddystone data
                const characteristic = await service.getCharacteristic('feaa');

                // Start listening for notifications
                characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = event.target.value;
                    console.log('Characteristic value changed:', value);
                    // handleEddystonePacket(value.buffer);  // You can implement this to process the packet
                });
            } catch (error) {
                console.error('Error connecting to Bluetooth device:', error);
            }
        }

        connectBtn.addEventListener('click', connectToEddystoneBeacon);
    </script>

</body>
</html>