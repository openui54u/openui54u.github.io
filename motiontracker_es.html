<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eddystone Beacon Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        #connectBtn {
            padding: 15px 30px;
            font-size: 18px;
            margin: 20px;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            background-color: blue;
            color: white;
        }
        #output {
            margin-top: 30px;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <h1>Eddystone Beacon Tracker</h1>

    <button id="connectBtn">SCAN FOR BEACON</button>

    <div id="output">
        <p><strong>Beacon Data:</strong></p>
        <p id="beaconType">Type: Unknown</p>
        <p id="beaconId">ID: N/A</p>
        <p id="beaconURL">URL: N/A</p>
        <p id="battery">Battery: N/A</p>
        <p id="temperature">Temperature: N/A</p>
    </div>

    <script>
        const connectBtn = document.getElementById('connectBtn');
        const beaconType = document.getElementById('beaconType');
        const beaconId = document.getElementById('beaconId');
        const beaconURL = document.getElementById('beaconURL');
        const battery = document.getElementById('battery');
        const temperature = document.getElementById('temperature');

        // Eddystone Frame Types
        const EDDYSTONE_UID = 0x00;
        const EDDYSTONE_URL = 0x10;
        const EDDYSTONE_TLM = 0x20;

        // URL decoding map
        const urlSchemePrefixes = ["http://www.", "https://www.", "http://", "https://"];
        const urlExpansions = [".com/", ".org/", ".edu/", ".net/", ".info/", ".biz/", ".gov/"];

        // Function to decode URL from Eddystone URL frame
        function decodeEddystoneURL(data) {
            let url = urlSchemePrefixes[data[0]];
            for (let i = 1; i < data.length; i++) {
                const charCode = data[i];
                if (charCode < urlExpansions.length) {
                    url += urlExpansions[charCode];
                } else {
                    url += String.fromCharCode(charCode);
                }
            }
            return url;
        }

        // Function to handle Eddystone packet
        function handleEddystonePacket(dataView) {
            const frameType = dataView.getUint8(0);

            switch (frameType) {
                case EDDYSTONE_UID:
                    const namespace = Array.from(new Uint8Array(dataView.buffer.slice(2, 12)))
                        .map(b => b.toString(16).padStart(2, '0')).join('');
                    const instance = Array.from(new Uint8Array(dataView.buffer.slice(12, 18)))
                        .map(b => b.toString(16).padStart(2, '0')).join('');
                    beaconType.textContent = 'Type: Eddystone-UID';
                    beaconId.textContent = `Namespace: ${namespace}, Instance: ${instance}`;
                    break;

                case EDDYSTONE_URL:
                    const url = decodeEddystoneURL(new Uint8Array(dataView.buffer.slice(2)));
                    beaconType.textContent = 'Type: Eddystone-URL';
                    beaconURL.textContent = `URL: ${url}`;
                    break;

                case EDDYSTONE_TLM:
                    const batteryVoltage = (dataView.getUint8(2) << 8) | dataView.getUint8(3);
                    const temp = dataView.getUint8(4) + dataView.getUint8(5) / 256;
                    beaconType.textContent = 'Type: Eddystone-TLM';
                    battery.textContent = `Battery Voltage: ${batteryVoltage} mV`;
                    temperature.textContent = `Temperature: ${temp.toFixed(1)} Â°C`;
                    break;

                default:
                    beaconType.textContent = 'Type: Unknown';
                    console.log('Unknown Eddystone frame type');
            }
        }

        // Function to start BLE scan and handle advertising packets
        async function startBLEScan() {
            try {
                const options = {
                    filters: [{ namePrefix: 'HolyIOT' }],
                    keepRepeatedDevices: true
                };

                const scan = await navigator.bluetooth.requestLEScan(options);

                navigator.bluetooth.addEventListener('advertisementreceived', event => {
                    console.log('Advertisement received:', event);

                    const dataView = new DataView(event.manufacturerData.get(0xfeaa).buffer);
                    handleEddystonePacket(dataView);
                });

            } catch (error) {
                console.error('Error during BLE scan:', error);
            }
        }

        // Attach click event listener to start BLE scanning
        connectBtn.addEventListener('click', startBLEScan);

    </script>

</body>
</html>