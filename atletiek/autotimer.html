<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gyroscope Web App with Timer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding-top: 50px;
        }
        #status, #timer, #auto-tare-progress {
            margin-top: 20px;
            font-size: 18px;
            color: green;
        }
        #x-value, #gyro-x-value {
            color: red;
        }
        #y-value, #gyro-y-value {
            color: green;
        }
        #z-value, #gyro-z-value {
            color: blue;
        }
        input, button {
            font-size: 16px;
            padding: 10px;
            margin: 10px;
        }
        input {
            max-width: 10vw;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
        }
        #manual-start-btn, #manual-stop-btn {
            background-color: lightblue;
            margin: 5px;
        }
        .bar-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .bar {
            height: 20px;
            margin: 0 5px;
            background-color: blue;
            transition: width 0.1s;
        }
        #bar-x {
            background-color: red;
        }
        #bar-y {
            background-color: green;
        }
        #bar-z {
            background-color: blue;
        }
    </style>
</head>
<body>
    <h1>Gyroscopic Timer</h1>
    <p>Set acceleration threshold (XYZ-axis):</p>
    <input type="number" id="accel-threshold" value="20" step="1">-
    <input type="number" id="accel-threshold-Stop" value="50" step="1">
    <button id="start-stop-btn">Start Monitoring (Gyro)</button>
    <button id="tare-btn">Tare (Gyro)</button>
    <button id="manual-start-btn">Manual Start</button>
    <button id="manual-stop-btn" disabled>Manual Stop</button>
    
    <p id="status">Status: Not Started</p>
    <p id="timer">Timer: 00:00:00:000</p>
    <p id="auto-tare-progress">Auto Tare Progress: 0s / 0s</p>

    <div class="bar-container">
        <div id="bar-x" class="bar"></div>
        <div id="bar-y" class="bar"></div>
        <div id="bar-z" class="bar"></div>
    </div>
    
    <p>X: <span id="x-value">0.00</span> m/s²</p>
    <p>Y: <span id="y-value">0.00</span> m/s²</p>
    <p>Z: <span id="z-value">0.00</span> m/s²</p>
    <p>Gyroscope X: <span id="gyro-x-value">0.00</span> °/s</p>
    <p>Gyroscope Y: <span id="gyro-y-value">0.00</span> °/s</p>
    <p>Gyroscope Z: <span id="gyro-z-value">0.00</span> °/s</p>

    <script>
        let monitoring = false;
        let motionHandlerX, motionHandlerY, motionHandlerZ;
        let threshold = 2; // Default acceleration threshold
        let thresholdStop = 3; // Default acceleration threshold for stopping
        let startTime = null;
        let intervalID = null;
        let isManuallyStarted = false;
        let tareValues = { x: 0, y: 0, z: 0 }; // Tare values for x, y, z
        let Accel = { x: 0, y: 0, z: 0 };
        let Gyro = { x: 0, y: 0, z: 0 };

        let autoTareActive = false;
        let autoTareDuration = 5000; // 5 seconds default duration
        let autoTareStartTime = null;
        let autoTareProgressIntervalID = null;

        const statusText = document.getElementById('status');
        const timerDisplay = document.getElementById('timer');
        const autoTareProgressDisplay = document.getElementById('auto-tare-progress');
        const accelInput = document.getElementById('accel-threshold');
        const accelInputStop = document.getElementById('accel-threshold-Stop');
        const startStopButton = document.getElementById('start-stop-btn');
        const tareButton = document.getElementById('tare-btn');
        const manualStartButton = document.getElementById('manual-start-btn');
        const manualStopButton = document.getElementById('manual-stop-btn');
        const barX = document.getElementById('bar-x');
        const barY = document.getElementById('bar-y');
        const barZ = document.getElementById('bar-z');
        const xValueDisplay = document.getElementById('x-value');
        const yValueDisplay = document.getElementById('y-value');
        const zValueDisplay = document.getElementById('z-value');
        const gyroXDisplay = document.getElementById('gyro-x-value');
        const gyroYDisplay = document.getElementById('gyro-y-value');
        const gyroZDisplay = document.getElementById('gyro-z-value');

        // Timer Function to update display in hours:minutes:seconds:microseconds
        function startTimer() {
            startTime = Date.now();
            intervalID = setInterval(() => {
                const currentTime = Date.now();
                const elapsedTime = currentTime - startTime;

                const hours = Math.floor(elapsedTime / 3600000).toString().padStart(2, '0');
                const minutes = Math.floor((elapsedTime % 3600000) / 60000).toString().padStart(2, '0');
                const seconds = Math.floor((elapsedTime % 60000) / 1000).toString().padStart(2, '0');
                const milliseconds = (elapsedTime % 1000).toString().padStart(3, '0');

                timerDisplay.innerText = `Timer: ${hours}:${minutes}:${seconds}:${milliseconds}`;
            }, 10); // Update every 10 milliseconds
        }

        function stopTimer() {
            clearInterval(intervalID);
            intervalID = null;
        }

        // Request permission for iOS devices
        function requestGyroPermission() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                return DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            return true;
                        } else {
                            alert("Permission not granted for motion sensors.");
                            return false;
                        }
                    })
                    .catch(error => {
                        console.error("Error requesting permission:", error);
                        return false;
                    });
            }
            return Promise.resolve(true); // Non-iOS devices don't need permission
        }

        // Function to adjust acceleration based on gyroscope orientation
        function adjustForOrientation(accel, gyro) {
            const adjusted = {
                x: accel.x - gyro.x,
                y: accel.y - gyro.y,
                z: accel.z - gyro.z
            };
            return adjusted;
        }

        // Function to start monitoring motion
        function startMonitoring() {
            threshold = parseFloat(accelInput.value);
            thresholdStop = parseFloat(accelInputStop.value);
            monitoring = true;
            startStopButton.innerText = 'Stop Monitoring (Gyro)';
            statusText.innerText = 'Status: Monitoring started.';

            // Reset timer and display
            timerDisplay.innerText = `Timer: 00:00:00:000`;
            manualStartButton.disabled = true;
            manualStopButton.disabled = false;

            window.addEventListener('devicemotion', gyroHandler);
            window.addEventListener('devicemotion', accelerometerHandler);
        }

        // Set up gyroscope event handler
        const gyroHandler = function(event) {
            Gyro.x = event.rotationRate.alpha || 0;
            Gyro.y = event.rotationRate.beta || 0;
            Gyro.z = event.rotationRate.gamma || 0;

            gyroXDisplay.innerText = Gyro.x.toFixed(2);
            gyroYDisplay.innerText = Gyro.y.toFixed(2);
                        gyroZDisplay.innerText = Gyro.z.toFixed(2);
        };

        // Set up accelerometer event handler
        const accelerometerHandler = function(event) {
            Accel.x = event.acceleration.x || 0;
            Accel.y = event.acceleration.y || 0;
            Accel.z = event.acceleration.z || 0;

            // Adjusting acceleration values based on gyroscope readings
            const adjustedAccel = adjustForOrientation(Accel, Gyro);
            xValueDisplay.innerText = adjustedAccel.x.toFixed(2);
            yValueDisplay.innerText = adjustedAccel.y.toFixed(2);
            zValueDisplay.innerText = adjustedAccel.z.toFixed(2);

            // Update bar widths
            updateBars(adjustedAccel);
        };

        // Function to update bar visuals
        function updateBars(adjustedAccel) {
            const maxValue = 10; // Example max value for bar scaling
            barX.style.width = Math.min(Math.abs(adjustedAccel.x) * 10, maxValue) + 'px';
            barY.style.width = Math.min(Math.abs(adjustedAccel.y) * 10, maxValue) + 'px';
            barZ.style.width = Math.min(Math.abs(adjustedAccel.z) * 10, maxValue) + 'px';

            // Implement threshold checks
            if (Math.abs(adjustedAccel.x) > threshold) {
                // Handle exceeding threshold logic
            }
            if (Math.abs(adjustedAccel.x) > thresholdStop) {
                // Handle stopping logic
                stopMonitoring();
            }
        }

        // Function to stop monitoring
        function stopMonitoring() {
            monitoring = false;
            startStopButton.innerText = 'Start Monitoring (Gyro)';
            statusText.innerText = 'Status: Monitoring stopped.';
            manualStartButton.disabled = false;
            manualStopButton.disabled = true;
            window.removeEventListener('devicemotion', gyroHandler);
            window.removeEventListener('devicemotion', accelerometerHandler);
            stopTimer();
            if (autoTareActive) {
                stopAutoTare();
            }
        }

        // Function to perform tare operation
        function tare() {
            tareValues.x = Accel.x;
            tareValues.y = Accel.y;
            tareValues.z = Accel.z;

            statusText.innerText = `Tare values set: X: ${tareValues.x.toFixed(2)}, Y: ${tareValues.y.toFixed(2)}, Z: ${tareValues.z.toFixed(2)}`;
        }

        // Function to start auto tare
        function startAutoTare() {
            autoTareActive = true;
            autoTareStartTime = Date.now();
            autoTareProgressDisplay.innerText = `Auto Tare Progress: 0s / ${autoTareDuration / 1000}s`;

            const tareDuration = autoTareDuration / 1000; // Convert milliseconds to seconds
            const startTareTime = Date.now();

            autoTareProgressIntervalID = setInterval(() => {
                const elapsedTareTime = Math.floor((Date.now() - startTareTime) / 1000);
                autoTareProgressDisplay.innerText = `Auto Tare Progress: ${elapsedTareTime}s / ${tareDuration}s`;

                // Update tare values during this period
                tareValues.x += Accel.x;
                tareValues.y += Accel.y;
                tareValues.z += Accel.z;

                if (elapsedTareTime >= tareDuration) {
                    clearInterval(autoTareProgressIntervalID);
                    autoTareActive = false;
                    tareValues.x /= tareDuration;
                    tareValues.y /= tareDuration;
                    tareValues.z /= tareDuration;

                    // Set new thresholds based on tare values
                    threshold = Math.abs(tareValues.x) * 2; // Example of how to set new thresholds
                    thresholdStop = Math.abs(tareValues.x) * 4; // Example for stop threshold
                    statusText.innerText += `\nAuto Tare complete! New threshold set: ${threshold.toFixed(2)}, Stop threshold: ${thresholdStop.toFixed(2)}`;
                }
            }, 1000); // Update every second
        }

        // Event listeners for buttons
        startStopButton.addEventListener('click', async () => {
            if (!monitoring) {
                const permissionGranted = await requestGyroPermission();
                if (permissionGranted) {
                    startMonitoring();
                    startTimer();
                }
            } else {
                stopMonitoring();
            }
        });

        tareButton.addEventListener('click', tare);

        manualStartButton.addEventListener('click', () => {
            if (!isManuallyStarted) {
                isManuallyStarted = true;
                manualStartButton.disabled = true;
                manualStopButton.disabled = false;
                startTimer();
            }
        });

        manualStopButton.addEventListener('click', () => {
            isManuallyStarted = false;
            manualStartButton.disabled = false;
            manualStopButton.disabled = true;
            stopTimer();
        });

        // Start the auto tare process when the button is clicked
        document.getElementById('start-auto-tare-btn').addEventListener('click', () => {
            startAutoTare();
        });

    </script>
</body>
</html>