<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Monitoring App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .status {
            margin-top: 20px;
            font-weight: bold;
        }
        #timer {
            font-size: 18px;
            margin-top: 10px;
        }
        #magnitude {
            font-size: 18px;
            margin-top: 10px;
        }
        #graph {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .bar {
            width: 20px;
            background-color: #007bff;
            border-radius: 5px;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Motion Monitoring App</h1>
        <label for="accel-threshold">Acceleration Threshold:</label>
        <input type="number" id="accel-threshold" value="2" step="0.1"><br>
        <label for="accel-threshold-Stop">Stop Acceleration Threshold:</label>
        <input type="number" id="accel-threshold-Stop" value="1" step="0.1"><br>

        <button id="start-stop-btn">Start Monitoring (Gyro)</button>
        <button id="tare-btn">Tare</button>
        <button id="manual-start-btn">Start Timer</button>
        <button id="manual-stop-btn">Stop Timer</button>

        <p id="status" class="status">Status: Ready</p>
        <p id="timer">Timer: 00:00:00:000</p>
        <p id="magnitude">Magnitude: 0.00</p>

        <div id="graph">
            <div id="bar-x" class="bar" style="height: 0;"></div>
            <div id="bar-y" class="bar" style="height: 0;"></div>
            <div id="bar-z" class="bar" style="height: 0;"></div>
        </div>
    </div>

    <script>
        let monitoring = false;
        let motionHandlerX, motionHandlerY, motionHandlerZ;
        let threshold = 2; // Default acceleration threshold
        let thresholdStop = 1; // Default acceleration threshold for stopping
        let startTime = null;
        let intervalID = null;
        let tareValues = { x: 0, y: 0, z: 0 }; // Tare values for x, y, z
        let Accel = { x: 0, y: 0, z: 0 };
        let Gyro = { x: 0, y: 0, z: 0 };

        const statusText = document.getElementById('status');
        const timerDisplay = document.getElementById('timer');
        const accelInput = document.getElementById('accel-threshold');
        const accelInputStop = document.getElementById('accel-threshold-Stop');
        const startStopButton = document.getElementById('start-stop-btn');
        const tareButton = document.getElementById('tare-btn');
        const manualStartButton = document.getElementById('manual-start-btn');
        const manualStopButton = document.getElementById('manual-stop-btn');
        const magnitudeDisplay = document.getElementById('magnitude'); // Display for magnitude

        // Timer Function to update display in hours:minutes:seconds:milliseconds
        function startTimer() {
            startTime = Date.now();
            intervalID = setInterval(() => {
                const currentTime = Date.now();
                const elapsedTime = currentTime - startTime;

                const hours = Math.floor(elapsedTime / 3600000).toString().padStart(2, '0');
                const minutes = Math.floor((elapsedTime % 3600000) / 60000).toString().padStart(2, '0');
                const seconds = Math.floor((elapsedTime % 60000) / 1000).toString().padStart(2, '0');
                const milliseconds = (elapsedTime % 1000).toString().padStart(3, '0');

                timerDisplay.innerText = `Timer: ${hours}:${minutes}:${seconds}:${milliseconds}`;
            }, 10); // Update every 10 milliseconds
        }

        function stopTimer() {
            clearInterval(intervalID);
            intervalID = null; // Reset the interval ID
        }

        // Request permission for iOS devices
        function requestGyroPermission() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                return DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            return true;
                        } else {
                            alert("Permission not granted for motion sensors.");
                            return false;
                        }
                    })
                    .catch(error => {
                        console.error("Error requesting permission:", error);
                        return false;
                    });
            }
            return Promise.resolve(true); // Non-iOS devices don't need permission
        }

        // Function to adjust acceleration based on gyroscope orientation
        function adjustForOrientation(accel, gyro) {
            const adjusted = {
                x: accel.x - gyro.x,
                y: accel.y - gyro.y,
                z: accel.z - gyro.z
            };
            return adjusted;
        }

        // Function to update the graph bars
        function updateGraphBars(magnitude) {
            const barX = document.getElementById('bar-x');
            const barY = document.getElementById('bar-y');
            const barZ = document.getElementById('bar-z');

            barX.style.height = `${Math.min(magnitude * 50, 300)}px`; // Scale to max height of 300px
            barY.style.height = `${Math.min(magnitude * 50, 300)}px`;
            barZ.style.height = `${Math.min(magnitude * 50, 300)}px`;
        }

        // Function to start monitoring motion
        function startMonitoring() {
            threshold = parseFloat(accelInput.value);
            thresholdStop = parseFloat(accelInputStop.value);
            monitoring = true;
            startStopButton.innerText = 'Stop Monitoring (Gyro)';
            statusText.innerText = 'Status: Monitoring started.';

            // Reset timer and display
            timerDisplay.innerText = `Timer: 00:00:00:000`;
            manualStartButton.disabled = true;
            manualStopButton.disabled = false;

            window.addEventListener('devicemotion', gyroHandler);
            window.addEventListener('devicemotion', accelerometerHandler);
        }

        // Gyroscope handler
        const gyroHandler = function(event) {
            Gyro.x = event.rotationRate.alpha || 0;
            Gyro.y = event.rotationRate.beta || 0;
            Gyro.z = event.rotationRate.gamma || 0;
        };

        // Accelerometer handler
        const accelerometerHandler = function(event) {
            Accel.x = event.accelerationIncludingGravity.x - tareValues.x;
            Accel.y = event.accelerationIncludingGravity.y - tareValues.y;
            Accel.z = event.accelerationIncludingGravity.z - tareValues.z;

            const adjustedAccel = adjustForOrientation(Accel, Gyro);

            // Calculate the magnitude
            const magnitude = Math.sqrt(
                adjustedAccel.x ** 2 +
                adjustedAccel.y ** 2 +
                adjustedAccel.z ** 2
            );

            // Display the rounded magnitude
            magnitudeDisplay.innerText = `Magnitude: ${magnitude.toFixed(2)}`;

            // Update graph bars based on magnitude
            updateGraphBars(magnitude);

            // Start timer if magnitude exceeds threshold
            if (magnitude > threshold && !startTime) {
                startTimer();
            }

            // Stop timer if magnitude goes below the stop threshold
            if (magnitude < thresholdStop && startTime) {
                stopTimer();
                statusText.innerText = 'Status: Monitoring stopped.';
                monitoring = false;
                startStopButton.innerText = 'Start Monitoring (Gyro)';
                manualStartButton.disabled = false;
                manualStopButton.disabled = true;
                                startTime = null; // Reset start time
            }
        };

        // Function to stop monitoring motion
        function stopMonitoring() {
            monitoring = false;
            if (intervalID) {
                stopTimer();
            }
            startStopButton.innerText = 'Start Monitoring (Gyro)';
            statusText.innerText = 'Status: Monitoring stopped.';
            manualStartButton.disabled = false;
            manualStopButton.disabled = true;

            // Remove the event listeners for accelerometer and gyroscope
            window.removeEventListener('devicemotion', gyroHandler);
            window.removeEventListener('devicemotion', accelerometerHandler);
        }

        // Function to tare the sensor
        function tare() {
            tareValues.x = Accel.x;
            tareValues.y = Accel.y;
            tareValues.z = Accel.z;
            statusText.innerText = 'Tare values set.';
        }

        // Button event listeners
        startStopButton.addEventListener('click', () => {
            if (monitoring) {
                stopMonitoring();
            } else {
                requestGyroPermission().then(permissionGranted => {
                    if (permissionGranted) {
                        startMonitoring();
                    } else {
                        alert('Motion sensor permissions not granted.');
                    }
                });
            }
        });

        tareButton.addEventListener('click', tare);
        
        manualStartButton.addEventListener('click', () => {
            startTimer(); // Manual start timer
            manualStartButton.disabled = true;
            manualStopButton.disabled = false;
        });

        manualStopButton.addEventListener('click', () => {
            stopTimer(); // Manual stop timer
            manualStopButton.disabled = true;
            manualStartButton.disabled = false;
        });

        // Initial request for gyroscope permission
        requestGyroPermission();
    </script>
</body>
</html>