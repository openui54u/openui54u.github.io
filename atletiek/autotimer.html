<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gyroscope Web App with Timer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding-top: 50px;
        }
        #status, #timer {
            margin-top: 20px;
            font-size: 18px;
            color: green;
        }
        
        #x-value {
            color: red
        }
        #y-value {
            color: green
        }
        #z-value {
            color: blue
        }
        
        input, button {
            font-size: 16px;
            padding: 10px;
            margin: 10px;
        }
        input {
            max-width: 10vw;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
        }
        #manual-start-btn, #manual-stop-btn {
            background-color: lightblue;
            margin: 5px;
        }
        .bar-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .bar {
            width: 20px;
            margin: 0 5px;
            background-color: blue;
            transition: height 0.1s;
        }
        #bar-x {
            background-color: red;
        }
        #bar-y {
            background-color: green;
        }
        #bar-z {
            background-color: blue;
        }
    </style>
</head>
<body>
    <h1>Gyroscopic Timer</h1>
    <p>Set acceleration threshold (XYZ-axis):</p>
    <input type="number" id="accel-threshold" value="3" step="1">
    <input type="number" id="accel-threshold-Stop" value="20" step="1">
    <button id="start-stop-btn">Start Monitoring (Gyro)</button>
    <button id="tare-btn">Tare (Gyro)</button>
    <button id="manual-start-btn">Manual Start</button>
    <button id="manual-stop-btn" disabled>Manual Stop</button>
    
    <p id="status">Status: Not Started</p>
    <p id="timer">Timer: 00:00:00:000</p>
    
    <div class="bar-container">
        <div id="bar-x" class="bar"></div>
        <div id="bar-y" class="bar"></div>
        <div id="bar-z" class="bar"></div>
    </div>
    
    <p>X: <span id="x-value">0.00</span> m/s²</p>
    <p>Y: <span id="y-value">0.00</span> m/s²</p>
    <p>Z: <span id="z-value">0.00</span> m/s²</p>

    <script>
        let monitoring = false;
        let motionHandlerX, motionHandlerY, motionHandlerZ;
        let threshold = 2;
        let thresholdStop = 3;
        let startTime = null;
        let intervalID = null;
        let isManuallyStarted = false;
        let tareValues = { x: 0, y: 0, z: 0 };
        let Accel = {x: 0, y: 0, z: 0};
        let gyroHandler = null;
        let gyroValues = { alpha: 0, beta: 0, gamma: 0 };

        const statusText = document.getElementById('status');
        const timerDisplay = document.getElementById('timer');
        const accelInput = document.getElementById('accel-threshold');
        const accelInputStop = document.getElementById('accel-threshold-Stop');
        const startStopButton = document.getElementById('start-stop-btn');
        const tareButton = document.getElementById('tare-btn');
        const manualStartButton = document.getElementById('manual-start-btn');
        const manualStopButton = document.getElementById('manual-stop-btn');
        const barX = document.getElementById('bar-x');
        const barY = document.getElementById('bar-y');
        const barZ = document.getElementById('bar-z');
        const xValueDisplay = document.getElementById('x-value');
        const yValueDisplay = document.getElementById('y-value');
        const zValueDisplay = document.getElementById('z-value');

        function startTimer() {
            startTime = Date.now();
            intervalID = setInterval(() => {
                const currentTime = Date.now();
                const elapsedTime = currentTime - startTime;

                const hours = Math.floor(elapsedTime / 3600000).toString().padStart(2, '0');
                const minutes = Math.floor((elapsedTime % 3600000) / 60000).toString().padStart(2, '0');
                const seconds = Math.floor((elapsedTime % 60000) / 1000).toString().padStart(2, '0');
                const milliseconds = (elapsedTime % 1000).toString().padStart(3, '0');

                timerDisplay.innerText = `Timer: ${hours}:${minutes}:${seconds}:${milliseconds}`;
            }, 10);
        }

        function stopTimer() {
            clearInterval(intervalID);
            intervalID = null;
        }

        // Permission request function for iOS
        async function requestPermissions() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                const motionPermission = await DeviceMotionEvent.requestPermission();
                const orientationPermission = await DeviceOrientationEvent.requestPermission();

                if (motionPermission === 'granted' && orientationPermission === 'granted') {
                    return true;
                } else {
                    alert("Permissions not granted for motion sensors.");
                    return false;
                }
            }
            return true;
        }

        // Gyroscope handler to capture orientation values
        gyroHandler = function (event) {
            gyroValues.alpha = event.alpha;
            gyroValues.beta = event.beta;
            gyroValues.gamma = event.gamma;
        };

        // Adjust acceleration values based on gyroscope orientation
        function adjustForOrientation(accel) {
            const alphaRad = gyroValues.alpha * (Math.PI / 180);
            const betaRad = gyroValues.beta * (Math.PI / 180);
            const gammaRad = gyroValues.gamma * (Math.PI / 180);

            const adjustedX = accel.x - Math.sin(gammaRad) * accel.z;
            const adjustedY = accel.y - Math.sin(betaRad) * accel.z;
            const adjustedZ = accel.z - Math.sin(alphaRad) * accel.x;

            return { x: adjustedX, y: adjustedY, z: adjustedZ };
        }

        async function startMonitoring() {
            const permissionGranted = await requestPermissions();
            if (!permissionGranted) return;

            monitoring = true;
            startStopButton.innerText = 'Stop Monitoring (Gyro)';
            statusText.innerText = 'Status: Monitoring started.';
            threshold = parseFloat(accelInput.value);
            thresholdStop = parseFloat(accelInputStop.value);

            tareValues = { x: 0, y: 0, z: 0 };

            window.addEventListener('devicemotion', (event) => {
                const rawAccel = {
                    x: event.accelerationIncludingGravity.x - tareValues.x,
                    y: event.accelerationIncludingGravity.y - tareValues.y,
                    z: event.accelerationIncludingGravity.z - tareValues.z
                };

                const adjustedAccel = adjustForOrientation(rawAccel);

                xValueDisplay.innerText = adjustedAccel.x.toFixed(2);
                yValueDisplay.innerText = adjustedAccel.y.toFixed(2);
                zValueDisplay.innerText = adjustedAccel.z.toFixed(2);

                barX.style.height = Math.max(0, adjustedAccel.x * 10) + 'px';
                barY.style.height = Math.max(0, adjustedAccel.y * 10) + 'px';
                barZ.style.height = Math.max(0, adjustedAccel.z * 10) + 'px';

                if (Math.abs(adjustedAccel.x) >= threshold && Math.abs(adjustedAccel.x) < thresholdStop) {
                    if (!intervalID) startTimer();
                }

                if (Math.abs(adjustedAccel.x) >= thresholdStop && intervalID) stopTimer();
            });

            window.addEventListener('deviceorientation', gyroHandler);
        }

        function stopMonitoring() {
            if (monitoring) {
                window.removeEventListener('devicemotion', motionHandlerX);
                window.removeEventListener('devicemotion', motionHandlerY);
                window.removeEventListener('devicemotion', motionHandlerZ);
                window.removeEventListener('deviceorientation', gyroHandler);
                clearInterval(intervalID);
                intervalID = null;
                monitoring = false;
                startStopButton.innerText = 'Start Monitoring (Gyro)';
                statusText.innerText = 'Status: Monitoring stopped.';
            }
        }

        startStopButton.addEventListener('click', async function () {
            if (!monitoring) {
                await startMonitoring();
            } else {
                stopMonitoring();
            }
        });

        manualStartButton.addEventListener('click', function () {
            if (!intervalID) {
                startTimer();
                statusText.innerText = 'Status: Timer manually';
                manualStopButton.disabled = false;
            }
        });

        manualStopButton.addEventListener('click', function () {
            if (intervalID) {
                stopTimer();
                statusText.innerText = 'Status: Timer manually stopped.';
                manualStopButton.disabled = true;
            }
        });

        tareButton.addEventListener('click', function () {
            // Set tare values to remove gravitational influence
            tareValues = { ...Accel };
            statusText.innerText = 'Status: Tare applied.';
        });

        // Format the bars to adjust dynamically based on acceleration values
        function updateBars(adjustedAccel) {
            barX.style.height = Math.min(Math.abs(adjustedAccel.x) * 10, 100) + 'px';
            barY.style.height = Math.min(Math.abs(adjustedAccel.y) * 10, 100) + 'px';
            barZ.style.height = Math.min(Math.abs(adjustedAccel.z) * 10, 100) + 'px';
        }

        // Function to display values with limited decimal points for better readability
        function displayValues(adjustedAccel) {
            xValueDisplay.innerText = adjustedAccel.x.toFixed(2);
            yValueDisplay.innerText = adjustedAccel.y.toFixed(2);
            zValueDisplay.innerText = adjustedAccel.z.toFixed(2);
        }

        async function main() {
            if (typeof DeviceMotionEvent !== 'undefined' && DeviceMotionEvent.requestPermission) {
                try {
                    const granted = await DeviceMotionEvent.requestPermission();
                    if (granted === 'granted') {
                        statusText.innerText = 'Status: Ready to start!';
                    } else {
                        statusText.innerText = 'Status: Permission denied!';
                    }
                } catch (error) {
                    statusText.innerText = 'Status: Unable to request permission.';
                }
            }
        }

        main();
    </script>
</body>
</html>